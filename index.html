<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base href="https://cdn.jsdelivr.net/gh/bubbls/UGS-Assets@main/gardenless/">
  <title>PvZ2 Gardendless Online | 0.6.0</title>
  
  <style>
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #000; overflow: hidden; }
    #GameDiv { width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; }
    #Cocos3dGameContainer { width: 100%; height: 100%; position: relative; }
    /* Force the canvas to the front and make it visible */
    canvas { 
      position: absolute; 
      top: 0; left: 0; 
      width: 100% !important; 
      height: 100% !important; 
      z-index: 999; 
      image-rendering: pixelated; /* Sharpens UI for Chromebooks */
    }
  </style>

  <script>
    (function() {
      // 1. WebGL Compatibility Fix (Addresses the Black Screen)
      const originalGetContext = HTMLCanvasElement.prototype.getContext;
      HTMLCanvasElement.prototype.getContext = function(type, attributes) {
        if (type === 'webgl' || type === 'webgl2') {
          attributes = Object.assign({}, attributes, {
            alpha: false, // Set to false to prevent background bleeding
            depth: true,
            stencil: true,
            antialias: false, // Disabling antialias can fix black screens on low-end GPUs
            premultipliedAlpha: false,
            preserveDrawingBuffer: false,
            powerPreference: "high-performance"
          });
        }
        return originalGetContext.call(this, type, attributes);
      };

      // 2. CORS Fix for assets
      const originalImage = window.Image;
      window.Image = function() {
        const img = new originalImage();
        img.crossOrigin = 'anonymous';
        return img;
      };
    })();
  </script>

  <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1,minimal-ui=true" />
  <link rel="stylesheet" type="text/css" href="style.f76d1.css" />
</head>

<body>
  <div id="GameDiv">
    <div id="Cocos3dGameContainer">
      <canvas id="GameCanvas" oncontextmenu="event.preventDefault()" tabindex="99"></canvas>
    </div>
  </div>

  <script src="src/polyfills.bundle.5adbf.js" charset="utf-8"></script>
  <script src="src/system.bundle.543e6.js" charset="utf-8"></script>
  <script src="src/import-map.4399c.json" type="systemjs-importmap" charset="utf-8"></script>

  <script>
    (function() {
      const fixDisplay = () => {
        const canvas = document.getElementById('GameCanvas');
        if (canvas) {
          // Force layout refresh
          canvas.style.display = 'none';
          canvas.offsetHeight; 
          canvas.style.display = 'block';
          
          // Manually trigger resize so the engine knows the window is active
          window.dispatchEvent(new Event('resize'));
        }
      };

      // Force Render Loop Fix
      const forceTick = setInterval(() => {
        if (window.cc && cc.director) {
          if (cc.director.isPaused && cc.director.isPaused()) {
            cc.director.resume();
          }
          // Manually invoke a frame if the screen is black
          cc.director.mainLoop();
        }
      }, 1000 / 30); // 30fps force-draw

      window.addEventListener('load', () => {
        System.import('./index.bed7f.js').then(() => {
            setTimeout(fixDisplay, 1000);
        }).catch(err => console.error(err));
      });

      // Emergency fix: if still black after 5 seconds, clear the background
      setTimeout(() => {
          document.getElementById('GameDiv').style.background = 'transparent';
          fixDisplay();
      }, 5000);
    })();
  </script>
</body>
</html>
