<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base href="https://cdn.jsdelivr.net/gh/bubbls/UGS-Assets@main/gardenless/">
  <title>PvZ2 Gardendless Online | 0.6.0</title>
  
  <script>
    (function() {
      // 1. Prevent Canvas Tainting (CORS Fix)
      const originalImage = window.Image;
      window.Image = function() {
        const img = new originalImage();
        img.crossOrigin = 'anonymous';
        return img;
      };

      // 2. High-Performance WebGL & Input Lag Fix
      const originalGetContext = HTMLCanvasElement.prototype.getContext;
      HTMLCanvasElement.prototype.getContext = function(type, attributes) {
        if (type === 'webgl' || type === 'webgl2') {
          attributes = Object.assign({}, attributes, {
            preserveDrawingBuffer: true,
            alpha: true,
            failIfMajorPerformanceCaveat: false,
            powerPreference: "high-performance",
            desynchronized: true 
          });
        }
        return originalGetContext.call(this, type, attributes);
      };
    })();
  </script>

  <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1,minimal-ui=true" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="format-detection" content="telephone=no">
  <meta name="full-screen" content="yes" />
  <meta name="x5-fullscreen" content="true" />
  <link rel="stylesheet" type="text/css" href="style.f76d1.css" />
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FNC28KV0ZR"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-FNC28KV0ZR');
  </script>
</head>

<body>
  <div id="GameDiv" cc_exact_fit_screen="true" style="width: 100vw; height: 100vh; background: #000;">
    <div id="Cocos3dGameContainer" style="width: 100%; height: 100%;">
      <canvas id="GameCanvas" oncontextmenu="event.preventDefault()" tabindex="99"></canvas>
    </div>
  </div>

  <script src="src/polyfills.bundle.5adbf.js" charset="utf-8"></script>
  <script src="src/system.bundle.543e6.js" charset="utf-8"></script>
  <script src="src/import-map.4399c.json" type="systemjs-importmap" charset="utf-8"></script>

  <script>
    (function() {
      console.log("Applying Enhanced Chromebook Fixes...");

      // GUI Visibility & Dimension Force
      const fixDisplay = () => {
        const canvas = document.getElementById('GameCanvas');
        const container = document.getElementById('Cocos3dGameContainer');
        if (canvas && container) {
          canvas.width = container.clientWidth || window.innerWidth;
          canvas.height = container.clientHeight || window.innerHeight;
          canvas.style.display = 'block';
          canvas.style.visibility = 'visible';
          canvas.style.opacity = '1';
          window.dispatchEvent(new Event('resize'));
        }
      };

      // Force Engine Tick (Fixes GUI not rendering/freezing)
      const forceTick = setInterval(() => {
        if (window.cc && cc.director) {
          if (!cc.director.isPaused()) {
            cc.director.mainLoop();
          }
        }
      }, 16);

      // Error Recovery for Module Loading
      window.addEventListener('error', function(e) {
        if (e.target.src && (e.target.src.includes('index') || e.target.src.includes('bundle'))) {
          console.warn("GUI asset load failed. Retrying...");
          setTimeout(() => {
            if (typeof System !== 'undefined') System.import('./index.bed7f.js');
          }, 2000);
        }
      }, true);

      window.addEventListener('load', () => {
        fixDisplay();
        // Start the game
        System.import('./index.bed7f.js').catch(err => console.error("Load Error:", err));
      });

      // Backup delay fix for slow Chromebook processors
      setTimeout(fixDisplay, 3000);
    })();
  </script>
</body>
</html>
