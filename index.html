<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base href="https://cdn.jsdelivr.net/gh/bubbls/UGS-Assets@main/gardenless/">
  <title>PvZ2 Gardendless Online | 0.6.0</title>
  
  <style>
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #000; overflow: hidden; }
    #GameDiv { width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; }
    #Cocos3dGameContainer { width: 100%; height: 100%; position: relative; }
    canvas { 
      position: absolute; 
      top: 0; left: 0; 
      width: 100% !important; 
      height: 100% !important; 
      z-index: 1; 
    }
  </style>

  <script>
    (function() {
      // 1. WebGL Layering Fix
      const originalGetContext = HTMLCanvasElement.prototype.getContext;
      HTMLCanvasElement.prototype.getContext = function(type, attributes) {
        if (type === 'webgl' || type === 'webgl2') {
          attributes = Object.assign({}, attributes, {
            alpha: true,
            depth: true,
            stencil: true,
            antialias: false,
            premultipliedAlpha: true,
            preserveDrawingBuffer: true, 
            powerPreference: "high-performance"
          });
        }
        return originalGetContext.call(this, type, attributes);
      };

      // 2. Asset Fetching Fix (Fixes invisible icons)
      const originalImage = window.Image;
      window.Image = function() {
        const img = new originalImage();
        img.crossOrigin = 'anonymous';
        return img;
      };
    })();
  </script>

  <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1,minimal-ui=true" />
  <link rel="stylesheet" type="text/css" href="style.f76d1.css" />
</head>

<body>
  <div id="GameDiv">
    <div id="Cocos3dGameContainer">
      <canvas id="GameCanvas" oncontextmenu="event.preventDefault()" tabindex="99"></canvas>
    </div>
  </div>

  <script src="src/polyfills.bundle.5adbf.js" charset="utf-8"></script>
  <script src="src/system.bundle.543e6.js" charset="utf-8"></script>
  <script src="src/import-map.4399c.json" type="systemjs-importmap" charset="utf-8"></script>

  <script>
    (function() {
      // 3. NUCLEAR UI FIX
      const forceUIElements = () => {
        if (!window.cc || !cc.director) return;
        
        const scene = cc.director.getScene();
        if (!scene) return;

        // Force every single node with 'UI' or 'Canvas' in it to be visible
        const allNodes = scene.getComponentsInChildren(cc.Component);
        allNodes.forEach(comp => {
          if (comp.node) {
            // Re-enable visibility
            comp.node.active = true;
            comp.node.opacity = 255;
            
            // Fix Camera Layering (Chromebooks often fail to render Layer 5/UI)
            if (comp.node.layer !== undefined) {
                comp.node.layer = 1 << 25; // Force to Global UI layer
            }
          }
        });

        // Force the camera to see the UI
        const cameras = scene.getComponentsInChildren(cc.Camera);
        cameras.forEach(cam => {
            cam.visibility |= (1 << 25); // Add UI layer to camera view
        });
      };

      const fixLayout = () => {
        window.dispatchEvent(new Event('resize'));
        const canvas = document.getElementById('GameCanvas');
        if (canvas) {
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
        }
      };

      // Rapid-fire fix for the first 10 seconds of a level
      setInterval(forceUIElements, 500);

      window.addEventListener('load', () => {
        System.import('./index.bed7f.js').then(() => {
          console.log("System Loaded. Applying Chromebook UI Overrides...");
          setTimeout(fixLayout, 2000);
        }).catch(err => console.error(err));
      });

      window.addEventListener('mousedown', () => {
          fixLayout();
          forceUIElements();
      }, { once: false });
    })();
  </script>
</body>
</html>
